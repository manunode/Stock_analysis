{% extends "base.html" %}

{% block title %}Compare Stocks - {{ APP_TITLE }}{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Compare Stocks</h1>
    <p class="mt-1 text-sm text-gray-500">Side-by-side comparison of up to 5 stocks</p>
</div>

<!-- Search / Add Stocks -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8" x-data="comparePicker()">
    <label class="block text-sm font-medium text-gray-700 mb-2">Select stocks to compare (max 5)</label>

    {# Selected chips #}
    <div class="flex flex-wrap gap-2 mb-3" x-show="selected.length > 0">
        <template x-for="(code, idx) in selected" :key="code">
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-sm font-semibold">
                <span x-text="code"></span>
                <button @click="remove(idx)" class="ml-0.5 hover:text-red-600 transition">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </span>
        </template>
    </div>

    {# Search input + dropdown #}
    <div class="flex flex-col sm:flex-row gap-3">
        <div class="flex-1 relative" @click.outside="results = []">
            <input type="text" x-model="query" @input.debounce.300ms="search()"
                   @focus="if(query.length > 0) search()"
                   @keydown.enter.prevent="if(results.length > 0) addFromResults(0)"
                   :placeholder="selected.length >= 5 ? 'Max 5 stocks selected' : 'Type to search stocks...'"
                   :disabled="selected.length >= 5"
                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none disabled:bg-gray-50 disabled:text-gray-400">

            {# Dropdown results #}
            <div x-show="results.length > 0" x-cloak
                 class="absolute left-0 right-0 mt-1 bg-white rounded-lg shadow-xl border border-gray-200 max-h-64 overflow-y-auto z-50">
                <template x-for="(r, i) in results" :key="r.nse_code">
                    <button @click="addFromResults(i)" type="button"
                            class="flex items-center justify-between w-full px-4 py-2.5 hover:bg-emerald-50 border-b border-gray-100 last:border-0 text-left transition">
                        <div>
                            <div class="font-semibold text-sm" x-text="r.nse_code"></div>
                            <div class="text-xs text-gray-500" x-text="r.stock_name"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400" x-text="r.sector"></div>
                            <span class="inline-block px-1.5 py-0.5 text-xs rounded font-medium"
                                  :class="r.score_band === 'A' ? 'bg-emerald-100 text-emerald-800' :
                                          r.score_band === 'B' ? 'bg-blue-100 text-blue-800' :
                                          r.score_band === 'C' ? 'bg-yellow-100 text-yellow-800' :
                                          'bg-gray-100 text-gray-600'"
                                  x-text="r.composite_score ? (r.composite_score + ' / ' + r.score_band) : '--'"></span>
                        </div>
                    </button>
                </template>
            </div>
        </div>

        <div class="flex items-start">
            <button @click="go()" :disabled="selected.length === 0"
                    class="px-6 py-2.5 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 transition-colors shadow-sm disabled:bg-gray-300 disabled:cursor-not-allowed">
                Compare
            </button>
        </div>
    </div>

    <p class="mt-2 text-xs text-gray-400">
        Search and pick up to 5 stocks, then click Compare.
        Example: <a href="/compare?stocks=RELIANCE,TCS,INFY" class="text-emerald-600 hover:underline">RELIANCE vs TCS vs INFY</a>
    </p>
</div>

{% if comparison | length == 0 %}
<!-- Empty State -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-16 text-center">
    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
    </svg>
    <h3 class="text-lg font-semibold text-gray-600 mb-1">Add stocks to compare</h3>
    <p class="text-sm text-gray-400">Enter stock codes above to see a side-by-side comparison.</p>
</div>

{% else %}
<!-- Comparison Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-gray-50 border-b-2 border-gray-200">
                    <th class="px-4 py-3 text-left font-semibold text-gray-600 min-w-[180px] sticky left-0 bg-gray-50 z-10">Metric</th>
                    {% for st in comparison %}
                    <th class="px-4 py-3 text-center font-semibold min-w-[140px]">
                        <a href="/stock/{{ st.nse_code }}" class="text-emerald-600 hover:text-emerald-700 hover:underline">
                            {{ st.nse_code }}
                        </a>
                        <div class="text-xs text-gray-400 font-normal truncate max-w-[140px]" title="{{ st.stock_name }}">
                            {{ st.stock_name }}
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">

                {#- ── Macro to render a row with best-value highlighting ── -#}
                {#- lower_better: for metrics where lower = better (PE, D/E, etc.) -#}
                {#- fmt_type: 'num', 'pct', 'raw', 'badge_band', 'badge_bucket', 'badge_risk', 'badge_val' -#}
                {%- macro cmp_row(label, key, fmt_type='num', lower_better=false) -%}
                {# Collect numeric values for best-detection #}
                {%- set ns = namespace(vals=[], best=none) -%}
                {%- for st in comparison -%}
                    {%- set v = st[key] -%}
                    {%- if v is not none and v is number -%}
                        {%- set ns.vals = ns.vals + [v] -%}
                    {%- endif -%}
                {%- endfor -%}
                {%- if ns.vals | length > 0 -%}
                    {%- if lower_better -%}
                        {%- set ns.best = ns.vals | min -%}
                    {%- else -%}
                        {%- set ns.best = ns.vals | max -%}
                    {%- endif -%}
                {%- endif -%}
                <tr class="hover:bg-gray-50/50">
                    <td class="px-4 py-2.5 font-medium text-gray-600 sticky left-0 bg-white z-10 border-r border-gray-100">{{ label }}</td>
                    {%- for st in comparison -%}
                    {%- set v = st[key] -%}
                    {%- set is_best = (v is not none and v is number and ns.best is not none and v == ns.best and ns.vals | length > 1) -%}
                    <td class="px-4 py-2.5 text-center tabular-nums {{ 'bg-green-50' if is_best else '' }}">
                        {%- if fmt_type == 'pct' -%}
                            {{ v | pct }}
                        {%- elif fmt_type == 'num' -%}
                            {{ v | fmt }}
                        {%- elif fmt_type == 'raw' -%}
                            {{ v if v is not none else '--' }}
                        {%- elif fmt_type == 'badge_band' -%}
                            {%- set bc = BAND_COLORS.get(v, {"bg": "bg-gray-100", "text": "text-gray-600"}) -%}
                            <span class="inline-block px-2 py-0.5 rounded text-xs font-bold {{ bc.bg }} {{ bc.text }}">{{ v or '--' }}</span>
                        {%- elif fmt_type == 'badge_bucket' -%}
                            {%- set bc = BUCKET_COLORS.get(v, {"bg": "bg-gray-400", "text": "text-gray-800"}) -%}
                            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {{ bc.bg }} {{ bc.text }}">{{ BUCKET_LABELS.get(v, v or '--') }}</span>
                        {%- elif fmt_type == 'badge_risk' -%}
                            {%- set rc = RISK_COLORS.get(v, {"bg": "bg-gray-100", "text": "text-gray-600", "dot": "bg-gray-400"}) -%}
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium {{ rc.bg }} {{ rc.text }}">
                                <span class="w-1.5 h-1.5 rounded-full {{ rc.dot }}"></span>{{ v or '--' }}
                            </span>
                        {%- elif fmt_type == 'badge_val' -%}
                            {%- set vc = VALUATION_COLORS.get(v, {"bg": "bg-gray-100", "text": "text-gray-600"}) -%}
                            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium {{ vc.bg }} {{ vc.text }}">{{ v or '--' }}</span>
                        {%- else -%}
                            {{ v if v is not none else '--' }}
                        {%- endif -%}
                    </td>
                    {%- endfor -%}
                </tr>
                {%- endmacro -%}

                {#- ── Group header macro ── -#}
                {%- macro group_header(title) -%}
                <tr class="bg-gray-50/80">
                    <td colspan="{{ comparison | length + 1 }}" class="px-4 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider border-y border-gray-200">
                        {{ title }}
                    </td>
                </tr>
                {%- endmacro -%}

                <!-- Identity -->
                {{ group_header('Identity') }}
                {{ cmp_row('Sector', 'sector', 'raw') }}
                {{ cmp_row('Market Cap', 'market_cap', 'num') }}
                {{ cmp_row('LTP', 'ltp', 'num') }}
                {{ cmp_row('Score', 'composite_score', 'num') }}
                {{ cmp_row('Band', 'score_band', 'badge_band') }}
                {{ cmp_row('Decision', 'decision_bucket', 'badge_bucket') }}
                {{ cmp_row('Quality Risk', 'quality_risk', 'badge_risk') }}

                <!-- Valuation -->
                {{ group_header('Valuation') }}
                {{ cmp_row('PE', 'pe', 'num', true) }}
                {{ cmp_row('PBV', 'pbv', 'num', true) }}
                {{ cmp_row('PEG', 'peg', 'num', true) }}
                {{ cmp_row('EV/EBITDA', 'ev_ebitda', 'num', true) }}
                {{ cmp_row('Valuation Band', 'valuation_band', 'badge_val') }}
                {{ cmp_row('Return 1Yr', 'return_1yr', 'pct') }}

                <!-- Quality -->
                {{ group_header('Quality') }}
                {{ cmp_row('Business Quality', 'business_quality_score', 'num') }}
                {{ cmp_row('Piotroski', 'piotroski_score', 'num') }}
                {{ cmp_row('ROE', 'roe_latest', 'pct') }}
                {{ cmp_row('ROCE', 'roce_latest', 'pct') }}
                {{ cmp_row('ROA', 'roa_latest', 'pct') }}
                {{ cmp_row('OPM', 'opm_latest', 'pct') }}
                {{ cmp_row('NPM', 'npm_latest', 'pct') }}

                <!-- Growth -->
                {{ group_header('Growth') }}
                {{ cmp_row('Rev Growth TTM', 'revenue_growth_ttm', 'pct') }}
                {{ cmp_row('NP Growth TTM', 'np_growth_ttm', 'pct') }}
                {{ cmp_row('EPS Growth 3Yr', 'eps_growth_3yr', 'pct') }}
                {{ cmp_row('Growth Durability', 'growth_durability_score', 'num') }}

                <!-- Financial Health -->
                {{ group_header('Financial Health') }}
                {{ cmp_row('Debt/Equity', 'debt_equity', 'num', true) }}
                {{ cmp_row('Interest Coverage', 'interest_coverage', 'num') }}
                {{ cmp_row('Current Ratio', 'current_ratio', 'num') }}
                {{ cmp_row('Fin Strength', 'financial_strength_score', 'num') }}
                {{ cmp_row('CFO/PAT', 'cfo_pat_latest', 'pct') }}
                {{ cmp_row('Positive CFO Yrs', 'positive_cfo_years', 'raw') }}

                <!-- Ownership -->
                {{ group_header('Ownership') }}
                {{ cmp_row('Promoter Holding', 'promoter_holding', 'pct') }}
                {{ cmp_row('Promoter Pledge', 'promoter_pledge', 'pct', true) }}
                {{ cmp_row('Institutional', 'institutional_holding', 'pct') }}

                <!-- Risk -->
                {{ group_header('Risk') }}
                {{ cmp_row('Red Flags', 'red_flag_count', 'raw', true) }}
                {{ cmp_row('Quality Flags', 'quality_flag_count', 'raw', true) }}
                {{ cmp_row('Pricing Flags', 'pricing_flag_count', 'raw', true) }}

            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
